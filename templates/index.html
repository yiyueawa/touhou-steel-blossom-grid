{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="text-center mb-5">
            <h1 class="display-4 text-primary">
                <i class="fas fa-th-large"></i> 东方花硬种
            </h1>
            <p class="lead text-muted">将您的图片与东方角色一起制作专属九宫格</p>
        </div>

        <!-- 上传区域 -->
        <div class="card shadow-lg mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-upload"></i> 上传您的图片
                </h5>
            </div>
            <div class="card-body">
                <div id="upload-area" class="upload-area text-center p-5 border-dashed rounded">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <h5>点击选择图片或拖拽图片到这里</h5>
                    <p class="text-muted">支持 JPG, PNG, GIF, BMP, TIFF 格式，最大 16MB</p>
                    <input type="file" id="file-input" class="d-none" accept="image/*">
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                        <i class="fas fa-folder-open"></i> 选择文件
                    </button>
                </div>
                
                <!-- 进度条 -->
                <div id="progress-container" class="mt-3 d-none">
                    <div class="progress">
                        <div id="progress-bar" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="text-center mt-2">
                        <small id="progress-text" class="text-muted">正在处理...</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 结果展示区域 -->
        <div id="result-container" class="card shadow-lg d-none">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-check-circle"></i> 生成完成
                </h5>
            </div>
            <div class="card-body text-center">
                <div id="result-image-container" class="mb-3">
                    <!-- 生成的图片将在这里显示 -->
                </div>
                <div class="d-flex justify-content-center gap-2">
                    <a id="download-btn" href="#" class="btn btn-primary" download>
                        <i class="fas fa-download"></i> 下载九宫格
                    </a>
                    <button type="button" class="btn btn-secondary" onclick="resetUpload()">
                        <i class="fas fa-redo"></i> 重新制作
                    </button>
                </div>
            </div>
        </div>

        <!-- 说明区域 -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-info-circle text-info"></i> 使用说明
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success"></i> 上传您的图片</li>
                            <li><i class="fas fa-check text-success"></i> 系统自动将您的图片放在九宫格中心</li>
                            <li><i class="fas fa-check text-success"></i> 周围环绕8张精美的东方角色图片</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><i class="fas fa-star text-warning"></i> 支持多种图片格式</li>
                            <li><i class="fas fa-star text-warning"></i> 智能缩放保持画质</li>
                            <li><i class="fas fa-star text-warning"></i> 高清输出可直接使用</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 九宫格位置示意图 -->
<div class="row mt-5">
    <div class="col-lg-6 mx-auto">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-th"></i> 九宫格布局预览
                </h6>
            </div>
            <div class="card-body">
                <div class="grid-preview">
                    <div class="grid-container">
                        <div class="grid-item">角色1</div>
                        <div class="grid-item">角色2</div>
                        <div class="grid-item">角色3</div>
                        <div class="grid-item">角色4</div>
                        <div class="grid-item center-item">您的图片</div>
                        <div class="grid-item">角色5</div>
                        <div class="grid-item">角色6</div>
                        <div class="grid-item">角色7</div>
                        <div class="grid-item">角色8</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 文件上传相关的JavaScript代码
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('file-input');
    const uploadArea = document.getElementById('upload-area');
    const progressContainer = document.getElementById('progress-container');
    const resultContainer = document.getElementById('result-container');

    // 文件选择事件
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            uploadFile(e.target.files[0]);
        }
    });

    // 拖拽上传
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            uploadFile(files[0]);
        }
    });
});

function uploadFile(file) {
    // 检查文件类型
    if (!file.type.startsWith('image/')) {
        alert('请选择图片文件！');
        return;
    }

    // 检查文件大小 (16MB)
    if (file.size > 16 * 1024 * 1024) {
        alert('文件大小不能超过16MB！');
        return;
    }

    const formData = new FormData();
    formData.append('file', file);

    // 显示进度条
    document.getElementById('progress-container').classList.remove('d-none');
    document.getElementById('result-container').classList.add('d-none');
    
    // 模拟进度
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 90) progress = 90;
        updateProgress(progress, '正在处理图片...');
    }, 200);

    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        updateProgress(100, '处理完成！');
        
        setTimeout(() => {
            document.getElementById('progress-container').classList.add('d-none');
            
            if (data.success) {
                showResult(data.result_image);
            } else {
                alert('错误: ' + data.message);
            }
        }, 500);
    })
    .catch(error => {
        clearInterval(progressInterval);
        document.getElementById('progress-container').classList.add('d-none');
        console.error('Error:', error);
        alert('上传失败，请重试！');
    });
}

function updateProgress(percent, text) {
    document.getElementById('progress-bar').style.width = percent + '%';
    document.getElementById('progress-text').textContent = text;
}

function showResult(imageUrl) {
    const resultContainer = document.getElementById('result-container');
    const imageContainer = document.getElementById('result-image-container');
    const downloadBtn = document.getElementById('download-btn');
    
    imageContainer.innerHTML = `<img src="${imageUrl}" class="img-fluid rounded shadow" alt="生成的九宫格">`;
    downloadBtn.href = imageUrl;
    
    resultContainer.classList.remove('d-none');
    resultContainer.scrollIntoView({ behavior: 'smooth' });
}

function resetUpload() {
    document.getElementById('file-input').value = '';
    document.getElementById('result-container').classList.add('d-none');
    document.getElementById('progress-container').classList.add('d-none');
}
</script>
{% endblock %}